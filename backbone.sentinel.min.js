//     Backbone.Sentinel v0.1.0
//     Copyright (c) 2014
//     James Nicol <james@fundly.com>
//     Distributed under MIT license
//     git@github.com:jimmynicol/backbone.sentinel.git


!function(a,b){"use strict";if("function"==typeof define&&define.amd)define(["backbone","underscore"],function(c,d){return b(a,c,d)});else if("undefined"!=typeof exports){var c=require("underscore"),d=require("backbone");module.exports=b(a,d,c)}else a.Backbone.Sentinel=b(a,a.Backbone,a._)}(this,function(a,b,c){"use strict";function d(a){throw new Error('Please implement the "'+a+'" method!')}var e=b.$,f=[].slice,g={_canLog:!1,_logComponents:[],detectDebugMode:function(){if(window){var a,b;if(!c.has(window,"console"))return;a=this,b=window.location.search.replace(/^\?/,"").split("&"),c.each(b,function(b){/^log=/.test(b)&&(a._canLog=!0,a._logComponents=b.split("=")[1].split(","))})}},log:function(){if(this._canLog){if(-1===c.indexOf(this._logComponents,"debug")&&-1===c.indexOf(this._logComponents,this._name))return;if(this._name){var a=[this._name+":"].concat(f.call(arguments));console.log.apply(console,a)}else console.log.apply(console,arguments)}}};g.detectDebugMode();var h=function(){this._name="Sentinel",this._queue=[],this.routeMap=[],this.initializeRouter(),this.initializeStore();var a=this;e(function(){a.domLoaded=!0,a.queue()}),this.log("initialized!")};h.componentOptions={renderOnRegister:!0,renderOnRoute:!1,removeOffRoute:!1},h.Bootstrap={},h.StoreClass=b.Model;var i;h.getInstance=function(){return i||(i=new h),i},h.register=function(a){var b=h.getInstance();c.isArray(a)?c.each(a,function(a){b.registerComponent(a)}):b.registerComponent(a)},h.list=function(){var a=[],b=[],d=h.getInstance();return c.each(d.components,function(d){c.each(d.routes,function(c,e){a.push({Component:d._name,Route:e,Method:c}),b.push(d._name)})}),console.table?(console.table(a),"Number of Components: "+c.uniq(b).length):a};var j={queue:function(a,b){if("undefined"!=typeof a&&this._queue.push([a,b]),this.domLoaded===!0){var c,d,e=this._queue.length;for(c=0;e>c;c++)d=this._queue.shift(),"undefined"!=typeof d&&d[0].apply(this,d[1])}},registerComponent:function(a){c.has(a,"cid")||(a.cid=c.uniqueId("component")),this.components=this.components||{},this.components[a.cid]=a,a.sentinel||(a.sentinel=this),c.has(a,"sentinelOptions")||(a.sentinelOptions=h.componentOptions),a.on("all",c.bind(function(){this.sentinel.trigger.apply(this.sentinel,arguments)},a)),a.sentinelOptions.renderOnRegister===!0&&this.queue(this.renderComponent,[a]),a.routes&&this.registerRoutes(a),this.log(a._name+" registered!")},renderComponent:function(a){c.result(a,"render"),a._sentinelRendered=!0},registerRoutes:function(a){var b=this;c.each(a.routes,function(c,d){if(b.routeMap[d])throw"The route "+d+" has already been registered!";b.routeMap[d]={id:a.cid,func:c},b.queue(b.sentinelRoute,[d,c,a])})},sentinelRoute:function(a,c,d){this.route(a,d.cid+"-"+c),b.history.loadUrl()},initializeRouter:function(){var a=this;this.routeMap[""]={},this.route("","default"),b.history.on("route",function(){a.handleRoute.apply(a,[].slice.call(arguments,1))}),b.History.started===!1&&(this.log("start Backbone.history"),b.history.start())},handleRoute:function(a,b){var d,e,f,g;g=this,d=a.split("-")[0],e=a.split("-")[1],this.components&&(f=this.components[d]),this.log("handle route",arguments,f),f&&("render"!==e&&f.sentinelOptions.renderOnRoute&&f._sentinelRendered!==!0&&this.queue(this.renderComponent,[f]),f[e].apply(f,b));var h=[];c.each(this.components,function(a,b){c.indexOf(h,b)>-1||b!==d&&a.sentinelOptions.removeOffRoute===!0&&(a.remove&&a.remove.apply(a),a._sentinelRendered=!1,h.push(b))})},initializeStore:function(){var a=this;if("undefined"==typeof h.StoreClass)throw"Please define the Sentinel.StoreClass";this.store=new h.StoreClass(h.Bootstrap),this.store.on("all",function(){a.trigger.apply(a,arguments)})}};c.extend(h.prototype,g,b.Router.prototype,j);var k=h.Component=function(){var a={};this.sentinel=h.getInstance(),c.extend(a,h.componentOptions,this.sentinelOptions),this.sentinelOptions=a,b.View.apply(this,arguments)};k.extend=b.View.extend,k.include=function(a){return c.extend(this.prototype,a.prototype),this};var l={_name:"Component",sentinelOptions:{},render:function(){d("render")}};return c.extend(k.prototype,g,b.View.prototype,l),h.VERSION="0.1.0",h});