<!DOCTYPE html>

<html>
<head>
  <title>backbone.sentinel.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>backbone.sentinel.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <pre><code>Backbone.Sentinel v0<span class="number">.0</span><span class="number">.1</span>
Copyright (c) <span class="number">2014</span>
James Nicol &lt;james@fundly.com&gt;
Distributed under MIT license
git@github.com:jimmynicol/backbone.sentinel.git</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="backbone-sentinel">Backbone.Sentinel</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>This top-level, singleton class is designed as a manager of Backbone views.
Components, which are extensions of Backbone.View (either directly or via
Backbone.Sentinel.Component) are registered with Sentinel which will reject
anything with conflicting routes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
(<span class="function"><span class="keyword">function</span><span class="params">(root, factory)</span>{</span>
  <span class="string">'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>AMD: import Backbone and underscore into the factory</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (<span class="keyword">typeof</span> define === <span class="string">'function'</span> &amp;&amp; define.amd) {
    define([<span class="string">'backbone'</span>, <span class="string">'underscore'</span>], <span class="function"><span class="keyword">function</span><span class="params">(Backbone, _)</span>{</span>
      <span class="keyword">return</span> factory(root, Backbone, _);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>CommonJS: for Node.js or Browserify</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> exports !== <span class="string">'undefined'</span>) {
    <span class="keyword">var</span> _ = require(<span class="string">'underscore'</span>),
        Backbone = require(<span class="string">'backbone'</span>);
    module.exports = factory(root, Backbone, _);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Finally, as a browser global.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  } <span class="keyword">else</span> {
    root.Backbone.Sentinel = factory(root, root.Backbone, root._);
  }

}(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span><span class="params">(root, Backbone, _)</span>{</span>
  <span class="string">'use strict'</span>;

  <span class="keyword">var</span> $ = Backbone.$,
      slice = [].slice; <span class="comment">// grab the slice method off the Array prototype</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="sentinel-log">Sentinel Log</h2>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>All purpose logging utility that is mixed into the needed classes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> Log = {
  
    _canLog: <span class="literal">false</span>,
    _logComponents: [],
  
    detectDebugMode: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
  
      <span class="keyword">if</span> (window){
        <span class="keyword">var</span> _this, search;
  
        _this = <span class="keyword">this</span>;
        search = window.location.search.replace(<span class="regexp">/^\?/</span>, <span class="string">''</span>).split(<span class="string">'&amp;'</span>);
  
        _.each(search, <span class="function"><span class="keyword">function</span><span class="params">(part)</span>{</span>
          <span class="keyword">if</span> (<span class="regexp">/^log=/</span>.test(part)){
            _this._canLog = <span class="literal">true</span>;
            _this._logComponents = part.split(<span class="string">'='</span>)[<span class="number">1</span>].split(<span class="string">','</span>);
          }
        });
      }
    },
  
    log: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      <span class="keyword">if</span> (console &amp;&amp; <span class="keyword">this</span>._canLog){</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Check to see if we are requesting logging on a specific component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (_.indexOf(<span class="keyword">this</span>._logComponents, <span class="string">'debug'</span>) === -<span class="number">1</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Don’t log if this is against a component not in the list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> (_.indexOf(<span class="keyword">this</span>._logComponents, <span class="keyword">this</span>._name) === -<span class="number">1</span>){
            <span class="keyword">return</span>;
          }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Prepend the name of the component when possible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (<span class="keyword">this</span>._name){
          <span class="keyword">var</span> args  = [<span class="keyword">this</span>._name + <span class="string">':'</span>].concat(slice.call(arguments));
          console.log.apply(console, args);
        } <span class="keyword">else</span> {
          console.log.apply(console, arguments);
        }
      }
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Detect if the browser session should be logging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Log.detectDebugMode();</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h2 id="sentinel">Sentinel</h2>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Top level singleton to register each component, will throw errors if
components try to share routes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
  <span class="keyword">var</span> Sentinel = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">this</span>._name = <span class="string">'Sentinel'</span>;
    <span class="keyword">this</span>._queue = [];
    <span class="keyword">this</span>.routeMap = [];
  
    <span class="keyword">this</span>.initializeRouter();
    <span class="keyword">this</span>.initializeStore();</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>record when the DOM has loaded</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> _this = <span class="keyword">this</span>;
    $(<span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      _this.domLoaded = <span class="literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>flush the queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      _this.queue();
    });
  
    <span class="keyword">this</span>.log(<span class="string">'initialized!'</span>);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Default compoent options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Sentinel.componentOptions = {
    renderOnRegister: <span class="literal">true</span>,   <span class="comment">// typically true for in-page components not popups</span>
    renderOnRoute:    <span class="literal">false</span>,  <span class="comment">// typically true for popups</span>
    removeOffRoute:   <span class="literal">false</span>   <span class="comment">// typically true for popups</span>
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Placeholder for any data that is bootstrapped to the page and then
inserted into the Sentinel.store accessible by all components</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Sentinel.Bootstrap = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Singleton method to make sure we only have one instance of Sentinel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> instance;
  Sentinel.getInstance = <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
    <span class="keyword">if</span> (!instance){
      instance = <span class="keyword">new</span> Sentinel();
    }
    <span class="keyword">return</span> instance;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Register a component with Sentinel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Sentinel.register = <span class="function"><span class="keyword">function</span><span class="params">(component)</span>{</span>
    <span class="keyword">var</span> sentinel = Sentinel.getInstance();
  
    <span class="keyword">if</span> (_.isArray(component)){
      _.each(component, <span class="function"><span class="keyword">function</span><span class="params">(c)</span>{</span>
        sentinel.registerComponent(c);
      });
    } <span class="keyword">else</span> {
      sentinel.registerComponent(component);
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>List all the components and their applicable routes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Sentinel.list = <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
    <span class="keyword">var</span> list = [],
        sentinel = Sentinel.getInstance();
  
    _.each(sentinel.components, <span class="function"><span class="keyword">function</span><span class="params">(c)</span>{</span>
      _.each(c.routes, <span class="function"><span class="keyword">function</span><span class="params">(method, route)</span>{</span>
        list.push({ Component: c._name, Route: route, Method: method });
      });
    });
  
    <span class="keyword">if</span> (console.table){
      console.table(list);
    } <span class="keyword">else</span> {
      <span class="keyword">return</span> list;
    }
  };
  
  <span class="keyword">var</span> SentinelMethods = {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Store functions to be run once the DOM has loaded</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    queue: <span class="function"><span class="keyword">function</span><span class="params">(func, args)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Push the function on to the queue if present</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (<span class="keyword">typeof</span> func !== <span class="string">'undefined'</span>){
        <span class="keyword">this</span>._queue.push([func, args]);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Loop through the queue once the DOM is loaded and run each function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (<span class="keyword">this</span>.domLoaded === <span class="literal">true</span>){
        <span class="keyword">var</span> i, next, queueLength = <span class="keyword">this</span>._queue.length;
  
        <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; queueLength; i++){
          next = <span class="keyword">this</span>._queue.shift();
          <span class="keyword">if</span> (<span class="keyword">typeof</span> next !== <span class="string">'undefined'</span>){
            next[<span class="number">0</span>].apply(<span class="keyword">this</span>, next[<span class="number">1</span>]);
          }
        }
      }
    },
  
    registerComponent: <span class="function"><span class="keyword">function</span><span class="params">(component)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>If the component is not a Backbone view, add a cid property using the
underscore uniqueId method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (!_.has(component,<span class="string">'cid'</span>)){
        component.cid = _.uniqueId(<span class="string">'component'</span>);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Add the registered component to an internal list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.components = <span class="keyword">this</span>.components || {};
      <span class="keyword">this</span>.components[component.cid] = component;</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Attach a reference to the Sentinel on the component if needed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (!component.sentinel){
        component.sentinel = <span class="keyword">this</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Make sure the component has an options hash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (!_.has(component,<span class="string">'sentinelOptions'</span>)){
        component.sentinelOptions = Sentinel.componentOptions;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Bubble all events from component to Sentinel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      component.on(<span class="string">'all'</span>, _.bind(<span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
        <span class="keyword">this</span>.sentinel.trigger.apply(<span class="keyword">this</span>.sentinel, arguments);
      }, component));</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Read component options and render if required</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (component.sentinelOptions.renderOnRegister === <span class="literal">true</span>){
        <span class="keyword">this</span>.queue(<span class="keyword">this</span>.renderComponent,[component]);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Register any routes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (component.routes){
        <span class="keyword">this</span>.registerRoutes(component);
      }
  
      <span class="keyword">this</span>.log(component._name + <span class="string">' registered!'</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Run the component render function and then set a rendered flag on the
component. This is a seperate method so it can be attached to the queue
and run when needed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    renderComponent: <span class="function"><span class="keyword">function</span><span class="params">(component)</span>{</span>
      _.result(component, <span class="string">'render'</span>);
      component._sentinelRendered = <span class="literal">true</span>;
    },
  
    registerRoutes: <span class="function"><span class="keyword">function</span><span class="params">(component)</span>{</span>
      <span class="keyword">var</span> _this = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>loop through each route and</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      _.each(component.routes, <span class="function"><span class="keyword">function</span><span class="params">(func, route)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>throw an error if the route has already been registered</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (_this.routeMap[route]){
          <span class="keyword">throw</span> <span class="string">'The route '</span> + route + <span class="string">' has already been registered!'</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>add the route and hash to <code>this.routeMap</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _this.routeMap[route] = { id: component.cid, func: func };</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>register the route with the backbone router
TODO: this is a dirty way of passing info with the route, try and
find a better way of attaching the component and function to the
route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _this.queue(_this.sentinelRoute, [route, func, component]);
      });
    },
  
    sentinelRoute: <span class="function"><span class="keyword">function</span><span class="params">(route, func, component)</span>{</span>
      <span class="keyword">this</span>.route(route, component.cid + <span class="string">'-'</span> + func);
      Backbone.history.loadUrl();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Initialize the router and capture the route change event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    initializeRouter: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      <span class="keyword">var</span> _this = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Attach a default route so we can hide components when all routes are
removed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.routeMap[<span class="string">''</span>] = {};
      <span class="keyword">this</span>.route(<span class="string">''</span>, <span class="string">'default'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Listen to the top-level route event to pass onto the sentinel method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      Backbone.history.on(<span class="string">'route'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Drop the redundant router argument when passing on</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _this.handleRoute.apply(_this, [].slice.call(arguments,<span class="number">1</span>));
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Start the history</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (Backbone.History.started === <span class="literal">false</span>){
        <span class="keyword">this</span>.log(<span class="string">'start Backbone.history'</span>);
        Backbone.history.start();
      }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Handle receiving the route and sending the info to the appropriate
component and method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    handleRoute: <span class="function"><span class="keyword">function</span><span class="params">(name, args)</span>{</span>
      <span class="keyword">var</span> cid, func, component, _this;
  
      _this = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Determine the component and bound method call for this route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cid = name.split(<span class="string">'-'</span>)[<span class="number">0</span>];
      func = name.split(<span class="string">'-'</span>)[<span class="number">1</span>];
      <span class="keyword">if</span> (<span class="keyword">this</span>.components){
        component = <span class="keyword">this</span>.components[cid];
      }
  
      <span class="keyword">this</span>.log(<span class="string">'handle route'</span>, arguments, component);</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>If a component matches this route, run the associated callbacks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (component){</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>If the bound callback is not render and the option to renderOnRoute
is set then render the component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (func !== <span class="string">'render'</span> &amp;&amp; component.sentinelOptions.renderOnRoute){</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Don’t re-render the component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> (component._sentinelRendered !== <span class="literal">true</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>On re-render it is up to the component author to handle attaching
component to the DOM.
e.g: in the render method <code>$(body).append(this.$el)</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.queue(<span class="keyword">this</span>.renderComponent, [component]);
          }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Run the method bound to this route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        component[func].apply(component, args);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Remove any components that are “offRoute”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> removed = [];
      _.each(<span class="keyword">this</span>.components, <span class="function"><span class="keyword">function</span><span class="params">(c, _cid)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Make sure we do not try and remove the component more than once</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (_.indexOf(removed, _cid) &gt; -<span class="number">1</span>){
          <span class="keyword">return</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>If required remove the component as the route changes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (_cid !== cid &amp;&amp; c.sentinelOptions.removeOffRoute === <span class="literal">true</span>){
          <span class="keyword">if</span> (c.remove){
            c.remove.apply(c);
          }
          c._sentinelRendered = <span class="literal">false</span>;
          removed.push(_cid);
        }
      });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Create a top-level model for data storage, broadcast any changes to the
model as events on Sentinel. Initialize with any data stored againts the
Bootstrap variable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    initializeStore: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
      <span class="keyword">var</span> _this = <span class="keyword">this</span>;
      <span class="keyword">this</span>.store = <span class="keyword">new</span> Backbone.Model(Sentinel.Bootstrap);
      <span class="keyword">this</span>.store.on(<span class="string">'all'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
        _this.trigger.apply(_this, arguments);
      });
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Merge in the methods, Logger and Router to the Sentinel prototype</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.extend(
    Sentinel.prototype,
    Log,
    Backbone.Router.prototype,
    SentinelMethods
  );
  
  <span class="function"><span class="keyword">function</span> <span class="title">methodNotImplemented</span><span class="params">(method)</span>{</span>
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Please implement the "'</span> + method + <span class="string">'" method!'</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <h2 id="sentinel-component">Sentinel Component</h2>

            </div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>This class is a simple extension of the Backbone.View and should be used
in roughly the same manner. The key exception is that you can nominate from
within the class what routes it should respond to.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> Component = Sentinel.Component = <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
    <span class="keyword">var</span> _so = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Attach a reference to Sentinel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">this</span>.sentinel = Sentinel.getInstance();</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Merge together the default options with the component specific ones</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.extend(_so, Sentinel.componentOptions, <span class="keyword">this</span>.sentinelOptions);
    <span class="keyword">this</span>.sentinelOptions = _so;</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Run the parent Backbone.View constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Backbone.View.apply(<span class="keyword">this</span>, arguments);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Add static extend method from the Backbone.View, Sentinel.Components are
designed to basically be a Backbone.View with some upgrades</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Component.extend = Backbone.View.extend;</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Add ability to include mixins in extended classes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Component.include = <span class="function"><span class="keyword">function</span><span class="params">(obj)</span> {</span>
    _.extend(<span class="keyword">this</span>.prototype, obj.prototype);
    <span class="keyword">return</span> <span class="keyword">this</span>;
  };
  
  <span class="keyword">var</span> ComponentMethods = {</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Override <code>_name</code> in the base class to help with logging, it will prefix
all log messages</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _name: <span class="string">'Component'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Set this in the component if any of the above defaults need to be
overriden</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sentinelOptions: {},</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Placeholder for the render method, it should be implemented.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    render: <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span> methodNotImplemented(<span class="string">'render'</span>); }
  };
  
  _.extend(
    Component.prototype,
    Log,
    Backbone.View.prototype,
    ComponentMethods
  );

  Sentinel.VERSION = <span class="string">'0.0.1'</span>;

  <span class="keyword">return</span> Sentinel;
}));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
