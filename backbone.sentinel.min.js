//     Backbone.Sentinel v0.0.1
//     Copyright (c) 2014
//     James Nicol <james@fundly.com>
//     Distributed under MIT license
//     git@github.com:jimmynicol/backbone.sentinel.git


!function(a,b){"use strict";if("function"==typeof define&&define.amd)define(["backbone","underscore"],function(c,d){return b(a,c,d)});else if("undefined"!=typeof exports){var c=require("underscore"),d=require("backbone");module.exports=b(a,d,c)}else a.Backbone.Sentinel=b(a,a.Backbone,a._)}(this,function(a,b,c){"use strict";function d(a){throw new Error('Please implement the "'+a+'" method!')}var e=b.$,f=[].slice,g={logDebugMode:function(){return window?/log=debug/.test(window.location.search):!1},log:function(){if(console&&this.logDebugMode())if(this._name){var a=[this._name+":"].concat(f.call(arguments));console.log.apply(console,a)}else console.log.apply(console,arguments)}},h=function(){this._name="Sentinel",this._queue=[],this.routeMap=[],this.initializeRouter(),this.initializeStore();var a=this;e(function(){a.domLoaded=!0,a.queue()}),this.log("initialized!")};h.componentOptions={renderOnRegister:!0,renderOnRoute:!1,removeOffRoute:!1},h.Bootstrap={};var i;h.getInstance=function(){return i||(i=new h),i},h.register=function(a){var b=h.getInstance();c.isArray(a)?c.each(a,function(a){b.registerComponent(a)}):b.registerComponent(a)},h.list=function(){var a=h.getInstance();return c.map(a.components,function(a){return{routes:a.routes,name:a._name}})};var j={queue:function(a,b){if("undefined"!=typeof a&&this._queue.push([a,b]),this.domLoaded===!0){var c,d,e=this._queue.length;for(c=0;e>c;c++)d=this._queue.shift(),"undefined"!=typeof d&&d[0].apply(this,d[1])}},registerComponent:function(a){c.has(a,"cid")||(a.cid=c.uniqueId("component")),this.components=this.components||{},this.components[a.cid]=a,a.sentinel||(a.sentinel=this),c.has(a,"sentinelOptions")||(a.sentinelOptions=h.componentOptions),a.on("all",c.bind(function(){this.sentinel.trigger.apply(this.sentinel,arguments)},a)),a.sentinelOptions.renderOnRegister===!0&&this.queue(this.renderComponent,[a]),a.routes&&this.registerRoutes(a),this.log(a._name+" registered!")},renderComponent:function(a){c.result(a,"render"),a._sentinelRendered=!0},registerRoutes:function(a){var b=this;c.each(a.routes,function(c,d){if(b.routeMap[d])throw"The route "+d+" has already been registered!";b.routeMap[d]={id:a.cid,func:c},b.queue(b.sentinelRoute,[d,c,a])})},sentinelRoute:function(a,c,d){this.route(a,d.cid+"-"+c),b.history.loadUrl()},initializeRouter:function(){var a=this;this.routeMap[""]={},this.route("","default"),b.history.on("route",function(){a.handleRoute.apply(a,[].slice.call(arguments,1))}),b.History.started===!1&&(this.log("start Backbone.history"),b.history.start())},handleRoute:function(a,b){var d,e,f,g;g=this,d=a.split("-")[0],e=a.split("-")[1],this.components&&(f=this.components[d]),this.log("handle route",arguments,f),f&&("render"!==e&&f.sentinelOptions.renderOnRoute&&f._sentinelRendered!==!0&&this.queue(this.renderComponent,[f]),f[e].apply(f,b));var h=[];c.each(this.components,function(a,b){c.indexOf(h,b)>-1||b!==d&&a.sentinelOptions.removeOffRoute&&(c.result(a,"remove"),a._sentinelRendered=!1,h.push(b))})},initializeStore:function(){var a=this;this.store=new b.Model(h.Bootstrap),this.store.on("all",function(){a.trigger.apply(a,arguments)})}};c.extend(h.prototype,g,b.Router.prototype,j);var k=c.extend(g,{_name:"Component",sentinelOptions:{},constructor:function(){var a={};this.sentinel=h.getInstance(),c.extend(a,h.componentOptions,this.sentinelOptions),this.sentinelOptions=a,b.View.apply(this,arguments)},render:function(){d("render")}}),l=h.Component=b.View.extend(k);return l.include=function(a){return c.extend(this.prototype,a.prototype),this},h.VERSION="0.0.1",h});